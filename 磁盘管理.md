# 磁盘管理

参考博文：https://blog.csdn.net/liushengxi_root/article/details/80962979

1. 合理有效利用磁盘：采用合理的文件存储空间分配算法，尽量减少磁盘碎片，提高硬盘的利用率。
2. 体会高磁盘的I/O速度：采用缓存等技术，提供访问速度。
3. 提高磁盘可靠性：采用冗余和纠错检错等技术，保证磁盘的数据不会被破坏。

## 外存的组织方式

​	**文件**是存放在**磁盘**上的，而磁盘是以**盘块**为基本的分配单位的。

1. 连续组织方式
2. 链接组织方式
3. 索引组织方式

### 连续组织方式

为每个文件分配一组连续的盘块。同一个文件内容存储在同一或相邻磁道上。

优点：顺序访问容易，访问速度快，寻道时间小。

缺点：容易产生外部碎片，难以知道文件长度，难以分配空间，难以删除和插入记录。

### 链接组织方式

​	为每个文件分配不连续的磁盘空间，通过链接指针将一个文件的所有盘块链接在一起，形成链式文件结构。分为隐式链接和显示链接两种。

#### 隐式链接

​	隐式链接的目录项需要包含文件的第一个盘块号和最后一个盘块号，每一个盘块都有一个值相下一块盘块的指针（最后一个盘块除外）。

缺点：只能顺序查找，速度慢；可靠性差，任何一个指针出现问题都会导致整个链的断开。

| file      | start | end  |
| --------- | ----- | ---- |
| file name | 9     | 25   |

#### 显式链接

​	将用于链接文件所有物理块的指针显示地存放在内存的一张链接表中，该表在整个磁盘中仅设置一张。而文件第一个盘块号作为文件的物理地址存放在FCB（文件控制块）中。而那个链接表则被叫做文件分配表（FAT: file allocation table）。

说明：

​	文件分配表的序号从0开始，直至N-1，N为盘块总数，在每一个盘块的末尾都有一个链接指针，指向下一个盘块。在该表中，凡是属于某一文件的第一个盘块号，均作为文件之地被填入相应的文件的FCB的物理地址字段中。由于查找记录的过程是在内存中进行的，因而提高了检索速度，减少了访问磁盘的次数；由于分配给文件的所有的盘块号都在该表中，故把该表成文文件分配表FAT。

缺点：

- 不能支持高效的直接存储，要对一个较大的文件进行直接存取，需首先在FAT中顺序地查找该文件所有的盘块号；
- FAT需要占用较大的内存空间，由于一个文件所占用的盘块的盘块号是随机地分布在FAT中的，因而只有将整个FAT调入内存，才能保证FAT中找到一个文件的所有盘块号，当磁盘容量较大时，FAT占用的容量更大。

### 索引组织方式

​	事实上，在打开某个文件时，只需要把该文件占用的盘块号的编号调入内存即可，不用将整个FAT调入内存。为此，将每个文件所对运营的盘块号集中地放在一起，索引分配方式就是基于这种想法所形成的一种分配方式。为每个文件分配一个索引块（表），再把分配给该文件的所有盘块号都记录再该索引块中，因而该索引块就是一个含有许多磁盘块号的数组。在建立一个文件时，只需要在位置建立的目录项中填上指向该索引块的指针。

说明：

​	索引方式支持直接访问，不会产生外部碎片。

缺点：

​	可能需要花费较多的外存空间，每当建立一个文件时，便须位置分配一个索引块，将分配给该文件的所有盘块号记录其中。

补充：

​	当文件大到一个索引块已经装不下的时候，可以为这些索引块再建立一级索引，成为第一级索引，在这个基础上，还可以建立第二季索引等等。被称为多级索引分配。

​	在二级索引的组织方式下，若每个盘块的大小为1KB，每个盘块号占4个字节，则在一个索引块中可以存放256个盘块号，在两级索引的情况下，最多可以存放的盘块号总数为：64K(256*256)。所允许的最大文件为64MB(64K\*1KB)。若盘块号为4KB，则一级索引最大文件大小为4MB，二级索引最大文件大小为4GB。

### Linux系统所采用的混合索引组织方式

​	小文件（小于40KB）：直接地址，在FCB中设置10个直接地址项，存放最多10个盘块号。假设每个盘块大小为4KB，当文件不大于40KB时，可以直接从FCB中读出该文件的全部盘号。

​	中文件（小于4MB+40KB）：一次间接地址，也就是一级索引组织方式。

​	大文件（大于4MB+40KB）：多次间接地址，二级索引组织方式的情况下，最大文件大小为4GB。

## 磁盘空闲盘块的管理

1. 空闲表法
2. 空闲链表法
3. 位试图法
4. 成组链接法

### 空闲表法

​	为外存上所有区域建立一张空间表，每个空闲区对应于一个空闲表项

| 序号 | 第一空闲盘块号 | 空闲盘块数 |
| :--: | :------------: | :--------: |
|  1   |       2        |     4      |
|  2   |       9        |     3      |
|  3   |       15       |     5      |
|  4   |      ...       |    ...     |

### 空闲链表法

​	每个空闲物理块中有指向下一个空闲物理块的指针，所有空闲物理块构成一个链表。

### 位视图法

​	在外存上建立一张位视图（bitmap），记录文件存储器的使用情况。每一位对应文件存储器上的一个盘块，取值0和1分别表示空闲和占用。

### 成组链接法

​	将空闲块分为若干组，每组的第一个空闲块记录的当前组的空闲块总数和下一组空闲块的盘块号。当某一组中记录的下一组的空闲块的盘块号为0时，意为最后一组空闲块组。